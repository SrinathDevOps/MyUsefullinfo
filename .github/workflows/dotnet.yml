name: .NET Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "6.0.x"

      - name: Restore dependencies
        run: dotnet restore
        working-directory: ./src/HelloWorldApp

      - name: Build
        run: dotnet build ./src/HelloWorldApp/HelloWorldapp.sln --configuration Release

      - name: Publish Application
        run: dotnet publish ./src/HelloWorldApp/HelloWorldapp.sln -c Release --output ./src/HelloWorldApp/myapp
        
      - name: Debug Logs
        run: |
          echo "ACR_USERNAME: $ACR_USERNAME"
          echo "ACR_PASSWORD: $ACR_PASSWORD"
      - name: Publish ACR Image
        env:
           ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
           ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
         # Log in to Azure Container Registry
         docker login argocdsrips.azurecr.io -u "$ACR_USERNAME" -p "$ACR_PASSWORD"
         # Build and push the Docker image see
         docker buildx build --file Dockerfile --tag argocdsrips.azurecr.io/hello-dotnet-app:latest --push .

   
      
      #- name: Set up Argo CD CLI
       # run: curl -LO https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 && chmod +x argocd-linux-amd64 && sudo mv argocd-linux-amd64 /usr/local/bin/argocd

      - name: Login to Argo CD
        run: argocd login --insecure --username admin --password 'ElevengthCorner@123' --server https://172.178.38.39:32362

      - name: Sync Argo CD application
        run: argocd app sync hello-dotnet-app
